<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=apINGrOhshowMVlno1R1f1Dl"></script>
        <title>ç™¾åº¦åœ°å›¾ Hello, World</title>
        <style type="text/css">
            body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;}
        </style>
    </head>
    <body>
        <div id="allmap"></div>
    </body>
</html>
<script type="text/javascript">

    // Â°Ã™Â¶ÃˆÂµÃ˜ÃÅ’APIÂ¹Å Ã„Ãœ
var map = new BMap.Map("allmap");            // Å½Å½Å“Å¡MapÃŠÂµÃ€Ã½
//var point = new BMap.Point(116.404, 39.915);    // Å½Å½Å“Å¡ÂµÃ£Ã—Ã¸Â±Ãª
var point = new BMap.Point(116.404, 39.915);    // Å½Å½Å“Å¡ÂµÃ£Ã—Ã¸Â±Ãª
map.centerAndZoom(point,15);                     // Â³ÃµÃŠÅ’Â»Â¯ÂµÃ˜ÃÅ’,Ã‰Ã¨Ã–ÃƒÃ–ÃÃÃ„ÂµÃ£Ã—Ã¸Â±ÃªÂºÃÂµÃ˜ÃÅ’Å’Â¶Â±Ã°Â¡Â£
map.enableScrollWheelZoom();                            //Ã†Ã´Ã“ÃƒÂ¹Ã¶Ã‚Ã–Â·Ã…Å½Ã³Ã‹ÃµÃÂ¡

var transit = new BMap.TransitRoute(map, {
renderOptions: {map: map}
});
transit.search("ÃÃµÅ¾Â®Å¸Â®", "ÃŽÃ·ÂµÂ¥");

map.setCurrentCity("Ã‰Ã®Ã›Ãš");

map.addControl(new BMap.NavigationControl());
//var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false, onSearchComplete:getLocalResults}}); 
var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false}}); 

local.setSearchCompleteCallback(getLocalResults);
local.setInfoHtmlSetCallback(infoCallback);

var plarr = new Array();
var blarr = new Array();

var lineshandle = 0;
var bls = new BMap.BusLineSearch(map,{
    renderOptions:{map:map, autoViewport:false},
        onGetBusListComplete: function(result){
           if(result) {
             var fstLine = result.getBusListItem(0);//»ñÈ¡µÚÒ»¸ö¹«½»ÁÐ±íÏÔÊ¾µ½mapÉÏ
             bls.getBusLine(fstLine);
           }
        },
        onGetBusLineComplete: function(line){
//        var polyline = line.getPolyline();
        var points = line.getPath();
        blarr.push(line);
        bls.clearResults();
        var polyline = new BMap.Polyline(points);
//        polyline.setStrokeColor("#555555");
//        polyline.setStrokeWeight(5);
        plarr.push(polyline);
        lineshandle = lineshandle + 1;
        if(lineshandle>=linescount){
            while(plarr.length>0){
                map.addOverlay(plarr.pop());
            }
        }
//        map.addOverlay(new BMap.Polyline(points));
        }
});


var txtMenuItem = [
{
text:"é™„è¿‘å…¬äº¤ç«™",
         callback:function(p){
             alert("local bus2");
             alert(p.lng + "," + p.lat);
             //        var marker = new BMap.Marker(p);
             //            map.addOverlay(marker);
             var circle = new BMap.Circle(p, 1000,{fillColor:"blue", strokeWeight: 1 ,fillOpacity: 0.3, strokeOpacity: 0.3});
             map.addOverlay(circle);
//             var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false, onSearchComplete:getLocalResults}});  
 //            var local =  new BMap.LocalSearch(map);  
             var bounds = getSquareBounds(circle.getCenter(),circle.getRadius());

	     alert("result cnt: 2");
             local.searchInBounds("å…¬äº¤ç«™", bounds);
	
             
         }
}
];

var linescount = 0;
function infoCallback(poi, html){
    linescount = 0;
    lineshandle = 0;
    alert("title: "+poi.title);
    alert("è½¦æ¬¡: "+html.innerText.replace("è½¦æ¬¡ï¼š", ""));
	var linesname = html.innerText.replace("è½¦æ¬¡ï¼š", "");
	var lines = linesname.split("; ");
    alert("total lines: "+lines.length);
    linescount = lines.length;
    for(var i=0; i<lines.length; i++){
        bls.getBusList(lines[i]);
    }


}

function wait(condition){
    if(!condition)
        setTimeout("wait()", 1000);
    else
        return true;
}

function getLocalResults(results){
//	var results = local.getResults();
	alert("search complete");
	alert("province:" + results.province + "radius:" + results.radius);
             var cnt = results.getNumPois();
	     alert("result cnt:" + cnt);
             for(var i=0; i<1; i++){
                var poi = results.getPoi(i);
                if(poi.type == BMAP_POI_TYPE_BUSSTOP){
		    alert("busstation title: " + poi.title);
		    alert("busstation url: " + poi.url);
                    addBusStation(poi.point);
		}
             }
}

var cm = new BMap.ContextMenu();
for(var i=0; i<txtMenuItem.length; i++){
    cm.addItem(new BMap.MenuItem(txtMenuItem[i].text, txtMenuItem[i].callback, 100));
}
map.addContextMenu(cm);

function addBusStation(point){
    map.addOverlay(new BMap.Marker(point));
}

//current city
function myFun(result){
    var cityName = result.name;
    map.setCenter(cityName);

}

function getSquareBounds(centerPoi,r){
        var a = Math.sqrt(2) * r; //Ã•Ã½Â·Å“ÃÃŽÂ±ÃŸÂ³â‚¬
      
        mPoi = getMecator(centerPoi);
        var x0 = mPoi.x, y0 = mPoi.y;
     
        var x1 = x0 + a / 2 , y1 = y0 + a / 2;//Â¶Â«Â±Â±ÂµÃ£
        var x2 = x0 - a / 2 , y2 = y0 - a / 2;//ÃŽÃ·Ã„ÃÂµÃ£
        
        var ne = getPoi(new BMap.Pixel(x1, y1)), sw = getPoi(new BMap.Pixel(x2, y2));
        return new BMap.Bounds(sw, ne);        
        
    }

    //Å¾Ã¹Å¸ÃÃ‡Ã²ÃƒÃ¦Ã—Ã¸Â±ÃªÂ»Ã±ÂµÃƒÃ†Å“ÃƒÃ¦Ã—Ã¸Â±ÃªÂ¡Â£
    function getMecator(poi){
        return map.getMapType().getProjection().lngLatToPoint(poi);
    }
    //Å¾Ã¹Å¸ÃÃ†Å“ÃƒÃ¦Ã—Ã¸Â±ÃªÂ»Ã±ÂµÃƒÃ‡Ã²ÃƒÃ¦Ã—Ã¸Â±ÃªÂ¡Â£
    function getPoi(mecator){
        return map.getMapType().getProjection().pointToLngLat(mecator);
    }


var myCity = new BMap.LocalCity();
myCity.get(myFun);


</script>

